---
title: "Installing the EJAM R package"
description: "1. Installing the EJAM R package"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Installing the EJAM R package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r developernote, eval=FALSE, echo= FALSE, include = FALSE}
#  *>>>>>>>>>> Developer note: vignettes need to be tested/edited/rebuilt regularly <<<<<<<<<<<*
#    - **See ?pkgdown::build_site** and script in EJAM/data-raw/- EJAM uses the pkgdown R package to build help and articles/ vignettes as web pages
```

```{r SETUP_default_eval_or_not, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
knitr::opts_chunk$set(eval = FALSE)
# https://r-pkgs.org/vignettes.html
```

```{r libraryEJAM, eval = FALSE, echo= FALSE, include= FALSE}
# rm(list = ls())
# golem::detach_all_attached()
# 
library(EJAM)
# dataload_from_pins('all') # varnames = all  currently means all these:
dataload_from_pins(
  c("blockwts", "blockpoints", "blockid2fips", "quaddata", 
    "bgej", "bgid2fips",
    "frs", "frs_by_programid", "frs_by_naics", "frs_by_sic", "frs_by_mact")
)

##################################### #
if (!exists("blockid2fips")) {
  cat("warning: blockid2fips not available\n")
  # *** temporary workaround if building vignette on 1 particular machine
  here <- "~/../Downloads/EJAMbigfiles"
  varnames <- c('blockwts', 'blockpoints', 'blockid2fips', "quaddata",
                'bgej','bgid2fips', 
                'frs', 'frs_by_programid', 'frs_by_naics', "frs_by_sic", "frs_by_mact")
  fnames <- paste0(varnames, ".arrow")
  localpaths  <- paste0(here, '/', fnames)
  for (i in 1:length(varnames)) {assign(varnames[i], arrow::read_ipc_file(file = localpaths[i]))}
  rm(here, varnames, fnames, localpaths)
}
##################################### #

indexblocks()
```

EJAM is not only a web app built in shiny R, it is also an R package, using the [golem](https://thinkr-open.github.io/golem/ "https://thinkr-open.github.io/golem/"){.uri target="_blank" rel="noreferrer noopener"} framework.

The development version of the app can be installed from the github USEPA github repository. It can be installed locally as an R package, and the data or functions can be used outside of the shiny app interface, if you want to reuse data or code, or want to do customized analysis or explore the data in R.

To install EJAM, you will need to have access to the relevant GitHub repository on EPA's enterprise github site, at [USEPA GitHub](https://github.com/USEPA "https://github.com/USEPA"){.uri target="_blank" rel="noreferrer noopener"}.

## How to install 

### Try this first

You can try this approach that uses `remotes::install_github()`:

``` r
if (!require(remotes)) {install.packages("remotes")}
remotes::install_github('USEPA/EJAM')

```
To install the development version, which may be newer but not yet fully working:
```{r}
if (!require(remotes)) {install.packages("remotes")}
remotes::install_github('USEPA/EJAM', ref = "development")
```



However, until the repository is made public, you need to be on VPN and also get a PAT to do this -- see details below.

### if you need the full source code or want to build/install in RStudio on your own

The only EPA/EJAM-specific package needed is the EJAM package itself.

That package is available on the [USEPA github](https://github.com/USEPA/EJAM "github.com/USEPA/EJAM"){.uri target="_blank" rel="noreferrer noopener"} (not CRAN)

-   [EJAM](https://github.com/USEPA/EJAM#readme "github.com/USEPA/EJAM"){.uri target="_blank" rel="noreferrer noopener"}

Options for getting the source package:

a.  One way to get the source package is that in RStudio you can click New Project, Version Control, Git, and enter the repository URL. It will download the full source package, which has additional files related to development that you do not need if you just want to use the package.

b.  Yet another way to get the full source package is to use a browser to go to the repository page, such as [USEPA github](https://github.com/USEPA/EJAM "github.com/USEPA/EJAM"){.uri target="_blank" rel="noreferrer noopener"} and then click the green "Code" button, and download and unzip the zip file that contains the package.

c.  A third way is to Clone or Fork the package via GitHub Desktop or from the GitHub site.

Regardless of how you got the full source code, you would then need to build/install the package from source on your computer using RStudio (using the Build menu) or using the devtools package, for example.

### if the repository is currently non-public (internal or private, for EPA only)

Note that if a USEPA github repository is not public, you need to be inside EPA's network (e.g., via VPN) and probably also need to get a personal access token (PAT):

1.  create a GitHub personal access token with 'repo scope'

- For background on this, see [https://usethis.r-lib.org/articles/git-credentials.html#tldr-use-https-2fa-and-a-github-personal-access-token](https://usethis.r-lib.org/articles/git-credentials.html#tldr-use-https-2fa-and-a-github-personal-access-token){.uri target="_blank" rel="noreferrer noopener"}

-   Go to [https://github.com/settings/tokens](https://github.com/settings/tokens){.uri target="_blank" rel="noreferrer noopener"} and select Tokens (classic) on the left-hand side. Then click 'Generate New Token' -\> Generate new token (classic).
-   Give it a name and select all boxes under repo scope. Scroll down and click 'Generate Token'.

2.  save GitHub credentials via Rstudio

-   one-time login: from the console, run `credentials::set_github_pat()`. Paste in your PAT to the login popup under 'Token'. This will save the PAT in your GITHUB_PAT environmental variable, where `remotes::install_github()` or `devtools::install_github()` will by default look for it.

3.  Try again to install the package using `devtools::install_github()`

#### CRAN packages needed (dependencies)

EJAM needs a number of other packages to be installed that are available from CRAN. Trying to load and attach EJAM with require(EJAM) or library(EJAM) will alert you to those other packages you need to install if you don't already have them. The list of CRAN packages needed is in the `DESCRIPTION` file in the R package source code root folder (as can be found in the code repository).


## Initialize: load/attach package

Once the right R packages are installed, to use EJAM in the console you can start by loading and attaching the package, using library or require. It should automatically download some data and build an index.

```{r libraryejam, eval=FALSE}
require(EJAM)
# or library(EJAM)
```

That should be all you need to do.


Just in case you need more details on how that works, the following describes the code used by the package to get the data and build an index.

### Details on the automatic data downloads

To work in the RStudio console, EJAM needs some datasets not stored as part of the package. However, they already should be downloaded and loaded into memory automatically as soon as you use `require(EJAM)`. If you want to check access, you can use `dataload_from_pins(justchecking = T)`. 

Typically you would not need to download any datasets yourself, because EJAM just downloads these when the app starts (technically, when the R package is attached) (or only as needed in the case of certain datasets that are not always needed). Some datasets are installed along with the package, such as the [blockgroupstats] data. But large files like "[blockpoints]" are stored on a "pins board" server and EJAM downloads them from there. You might want your own local copies, though, for these reasons:

1. If your computer canâ€™t immediately access the pins board server due to authentication/ credentials setup that you prefer to skip. Access to the datasets may change during development and before they are public datasets they might not be as easy to get access to without setting up access to the pins board, etc.
2. If you have local copies, EJAM avoids the slight delay of downloading some essential data (e.g., blockpoints) when you first do library(EJAM), and then when you first use EJ Indexes (relying on bgej) or the FRS/ NAICS/ SIC/ programid/ registryid features (relying on datasets like "frs" etc.).

In case you do want copies of the datasets EJAM normally downloads, and have access to those files, you can save them in the data subfolder of the EJAM package source code folder and then install from source. That way, the locally-run EJAM code avoids downloading them because it always first checks for local copies.

If you do have access to the pins board, and want to download them manually:

```{r dataload_from_pins, eval = FALSE}
dataload_from_pins(justchecking = T)
dataload_from_pins('all')
# It takes a moment for the large downloads, while EJAM is still in development.
```

Attaching the package actually checks for copies in memory first (e.g., `exists("quaddata", envir = globalenv())`), then local disk (using [dataload_from_local()] looking in the data folder of the (source or installed) package, as defined by `EJAM:::app_sys()` which is just a wrapper for `system.file()`), then finally tries to download any still needed, using [dataload_from_pins()] for example.

### Details on the indexing of blocks

EJAM also needs to build the index of about 8 million US block locations (one internal point for each block), which takes a few seconds. EJAM does this automatically when attached via `require(EJAM)` or `library(EJAM)`, by creating an object called [localtree](../reference/localtree.html) based on the [quaddata](../reference/quaddata.html) object obtained as mentioned above. Some functions check for it and try to build the index on the fly if it is missing. You can also (re)build it manually:

```{r indexblocks, eval=FALSE}
indexblocks()
```
