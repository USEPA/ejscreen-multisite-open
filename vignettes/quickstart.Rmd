---
title: "2. Quick Start Guide"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{2. Quick Start Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r SETUP_default_eval_or_not, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
knitr::opts_chunk$set(eval = FALSE)
# https://r-pkgs.org/vignettes.html
```

```{r echo=TRUE}
print(path.expand("~/../Downloads/EJAMbigfiles"))
```

```{r libraryEJAM, eval = TRUE, echo= FALSE, include= FALSE}
# rm(list = ls())
# golem::detach_all_attached()
# 
library(EJAM)
# dataload_from_pins('all') # varnames = all  currently means all these:
dataload_from_pins(
  c("blockwts", "blockpoints", "blockid2fips", "quaddata", 
    "bgej", "bgid2fips",
    "frs", "frs_by_programid", "frs_by_naics", "frs_by_sic", "frs_by_mact")
)

##################################### #
if (!exists("blockid2fips")) {
  cat("warning: blockid2fips not available\n")
  # *** temporary workaround if building vignette on 1 particular machine
  here <- "~/../Downloads/EJAMbigfiles"
  varnames <- c('blockwts', 'blockpoints', 'blockid2fips', "quaddata",
                'bgej','bgid2fips', 
                'frs', 'frs_by_programid', 'frs_by_naics', "frs_by_sic", "frs_by_mact")
  fnames <- paste0(varnames, ".arrow")
  localpaths  <- paste0(here, '/', fnames)
  for (i in 1:length(varnames)) {assign(varnames[i], arrow::read_ipc_file(file = localpaths[i]))}
  rm(here, varnames, fnames, localpaths)
}
##################################### #

indexblocks()
```

```{r developernote, echo= FALSE}
#
#  *>>>>>>>>>> Developer note on updating this vignette <<<<<<<<<<<*
#
#  -   *TO UPDATE THIS VIGNETTE:* 
#
#    - *This vignette must be regularly tested/edited*
#
#    -  rmarkdown::render("vignettes/INSERTNAMEHERE.Rmd", encoding = 'UTF-8') 
#     but the render button in RStudio shows more detailed progress during render.
#
#    -  possibly also devtools::build_vignettes() but that fails on dataload_from_pins() or _local() trying to get blockid2fips ... but maybe the problem is needing to be on VPN for the pins() to be available.
#
#  -    See <https://docs.ropensci.org/postdoc/> for quick way to make html help on a pkg. Do this...   postdoc::render_package_manual('EJAM') 
#
#  -   *See <https://r-pkgs.org/vignettes.html>*
#
#  -   *See <https://r-pkgs.org/vignettes.html#sec-vignettes-how-built>*
#
#  -   *Vignette is in EJAM\vignettes\INSERTNAMEHERE.Rmd.html*
```

# EJAM Analysis in R

## Quick Start

Here's how you can run an EJAM analysis and view results right away (once EJAM has been set up)

### Load EJAM (code and data)

```{r library, eval=TRUE}
library(EJAM)
```

### Analyze 100 Places

```{r ejamit100, message=FALSE, warning=FALSE, include=FALSE}
# EJAM analysis of 100 places, for everyone within 3 miles
x <- ejamit(testpoints_100, radius = 3, 
            silentinteractive = F, include_ejindexes = T)
```

### Map of Results

```{r map100, eval = TRUE}
mapfastej(x$results_bysite)

# Click a point on the map to see details about people near that point
```

### Table Summary

```{r table_gt, eval=TRUE}
# Summary of demographics
table_gt_from_ejamit(x) 
```

### Barplot Summary

```{r plot_barplot_ratios, eval=TRUE}
# Plot of demographics (will use simpler syntax in the future)
plot_barplot_ratios(unlist(
  x$results_overall[ , c(
    ..names_d_ratio_to_avg , 
    ..names_d_subgroups_ratio_to_avg
  )]))
```

### Spreadsheet Download

```{r ejam2excel, eval=FALSE, message=FALSE, warning=FALSE}
ejam2excel(x, launchexcel = T, save_now = F)
```

## How to Select Places to Analyze

### Use points already included with EJAM as examples

EJAM comes with examples of points you can use to try things out, like `testpoints_10`

```{r eval = TRUE, fig.height=4.83, fig.width=3}
testpoints_10
```

### Use one point

```{r one point, eval=FALSE}
pts <- data.frame(lon = -92.380556, lat = 31.316944)
```

### Use a few points

```{r sitepoints2, eval = TRUE}
sitepoints2  <- data.frame(
  lon = c(-92.1,      -91.8), 
  lat = c(34.8799123, 30.2906971), 
  ejam_uniq_id = 1:2
)
```

### Use a random sample of points that can represent the average facility, average resident, or average location

You can create a set of random points with function `testpoints_n()` that can be weighted to represent the average resident, average regulated facility, average point on a map weighted by square meters, etc. See more details in the documentation of the function testpoints_n().

```{r help_testpoints, eval = FALSE}
?testpoints_n
```

### Map your sites before analyzing them

```{r eval = FALSE}
mapfast(  testpoints_100)                  # input to EJAM
mapfastej(testoutput_ejamit_100pts_1miles) # output, results of EJAM
```

You can see a map of random blocks in a single State, for example:

```{r eval = TRUE, fig.height=6, fig.width=6}
if (exists("blockid2fips")) {
  pts <- testpoints_n(1000, weighting = 'blocks', ST_needed = "LA")
  mapfast(pts, radius = 0.1)
}
```

### Pick a Radius

You can specify the radius in miles. EJAM will analyze all residents within that many miles of each point (site).

```{r RADIUS, eval = TRUE}
radius <- 3 # radius (in miles).  5 km = 3.1 miles, 10 km = 6.2 miles
```

##### Convert between miles and kilometers

If you know you want to analyze for 5 kilometers, you can turn it into miles with something like

```{r convert units, eval=TRUE}
convert_units(5, 'km', 'miles')
```

## Analyze your Sites in 1 step with ejamit()

```{r eval=TRUE, echo=, message=FALSE, warning=FALSE}
x <- ejamit(testpoints_100, radius = 1) # 1 mile radius around each of 100 test/example points

# help("ejamit")
```

### Interactively select your own file of lat,lon coordinates, without shiny web app

From RStudio, you can use EJAM functions to interactively select a file from your folders, to upload a spreadsheet (.xlsx or .csv) with columns called lat and lon in the first row as the header row, and then one row per point.

```{r read_csv_or_xl, eval = FALSE}
y <- read_csv_or_xl()
names(y)
head(y)

# or 

# x <- ejamit(radius = 2) 
#  2 mile radius, and 
# prompts you to select spreadsheet with lat,lon values of points
```

### Map the EJAM Results

Popups in the map show key stats for residents near each site.

```{r eval = TRUE, echo= TRUE, fig.height=8, fig.width=6}
x <- testoutput_ejamit_100pts_1miles
mapfastej(x$results_bysite)
# help("mapfast")
```

### Open Results as a Spreadsheet (this Launches Excel)

```{r table_xls_from_ejam-launchexcel, eval = FALSE}
ejam2excel(ejamit(testpoints_10, radius = 1), launchexcel = T, save_now = F)
# table_xls_from_ejam()  is another name for  ejam2excel() 
```

### Save Results as Spreadsheet file

```{r table_xls_from_ejam-savenow, eval = FALSE}
ejam2excel(ejamit(testpoints_10, radius = 1), save_now = T)
```

=============

##### Use lat/lon coordinates in a table like a spreadsheet - xlsx or csv file

The first row should be column names including lat and lon, or something that can be interpreted as that - see latlon_infer()

```{r writecsv, eval = FALSE, include= TRUE}
testjunk <- file.path(tempdir(), 'testjunk.csv')
write.csv(data.frame(LONG = c(-92.1, -91.8), Latitude = c(34.8, 30.2), ejam_uniq_id = 1:2), file = testjunk, row.names = FALSE)
sitepoints2 <- latlon_from_anything(testjunk)
sitepoints2
```

##### Use test points in examples that comes with the package

```{r testpoints100, eval = TRUE, echo= TRUE}
testpoints_100 |> head(2) # data.table, in this package
sitepoints100 <- data.table::copy(testpoints_100)  # [1:5, ]
head(sitepoints100, 3)
```

##### Create random test data points in States of LA and TX

```{r mapfast_testpoints_n, eval = TRUE, fig.height=5, fig.width=5}
# ?testpoints_n
# p1k <- testpoints_n(1000)
# mapfast(p1k)

mapfast(testpoints_n(300, ST_needed = c('LA','TX'), weighting = 'bg')) 
# weighting = "frs" would better represent regulated facilities,
# but would require loading the frs dataset
```

## Documentation of Functions and Data

-   For the RStudio view of the package documentation, try `?EJAM`

-   For vignettes that walk through basics of using EJAM functions, try `vignette(package = "EJAM")`

-   A pdf version of documentation might be provided, possibly here: <https://github.com/USEPA/EJAM/tree/main/www>

-   An HTML version of documentation might be provided, possibly here: <https://github.com/USEPA/EJAM/tree/main/www>

-   In general, see the readme for links to documentation: <https://github.com/USEPA/EJAM/tree/main?tab=readme-ov-file#readme>

```{r helpEJAM, eval = FALSE, include= FALSE}
?EJAM
# or 
help("EJAM", package='EJAM')

?ejamit

vignette(package = "EJAM")
```
