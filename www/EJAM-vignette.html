<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Basics of using EJAM in RStudio</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Basics of using EJAM in RStudio</h1>



<div id="quickstart" class="section level2">
<h2>Quickstart</h2>
<div id="summary-of-demographics-and-environment-near-100-sites" class="section level3">
<h3>Summary of Demographics and Environment near 100 Sites</h3>
<p>In R/RStudio, clone/install EJAM package and related ones from <a href="https://github.com/USEPA/EJAM/#readme" class="uri">https://github.com/USEPA/EJAM/#readme</a>, etc.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(EJAM)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">ejamit</span>(<span class="fu">testpoints_n</span>(<span class="dv">100</span>),<span class="dv">1</span>) <span class="co"># 1 mile radius</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mapfast</span>(x<span class="sc">$</span>results_bysite)</span></code></pre></div>
</div>
<div id="interactively-point-to-your-file-with-latlon-coordinates-without-shiny-web-app" class="section level3">
<h3>Interactively point to your file with lat,lon coordinates, without
shiny web app</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">ejamit</span>(<span class="at">radius =</span> <span class="dv">2</span>) <span class="co">#  2 mile radius</span></span></code></pre></div>
</div>
<div id="specify-all-sites-in-1-industrial-sector" class="section level3">
<h3>Specify all sites in 1 industrial sector</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">naics_from_any</span>(<span class="st">&quot;paint and coating&quot;</span>, <span class="at">children =</span> T)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">ejamit</span>(<span class="fu">frs_from_naics</span>(<span class="st">&quot;paint and coating&quot;</span>),<span class="dv">1</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">latlon_from_naics</span>(<span class="dv">325510</span>)) <span class="co"># has about 1,000 facilities</span></span></code></pre></div>
</div>
<div id="specify-sites-by-facility-registry-id" class="section level3">
<h3>Specify sites by facility registry ID</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>EJAM<span class="sc">::</span><span class="fu">frs_from_siteid</span>(<span class="fu">c</span>(<span class="dv">110071293460</span>, <span class="dv">110000333826</span>))</span></code></pre></div>
</div>
<div id="specify-sites-by-facility" class="section level3">
<h3>Specify sites by facility</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>EJAM<span class="sc">::</span><span class="fu">latlon_from_programid</span>(<span class="fu">c</span>(<span class="st">&quot;XJW000012435&quot;</span>, <span class="st">&quot;00768SRTRSROAD1&quot;</span>))</span></code></pre></div>
</div>
<div id="specify-sites-by-epa-regulatory-program-or-epa-database" class="section level3">
<h3>Specify sites by EPA regulatory program or EPA database</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>EJAM<span class="sc">::</span><span class="fu">latlon_from_program</span>(<span class="st">&quot;CAMDBS&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="developer-note-on-building-and-updating-this-vignette" class="section level2">
<h2><em>Developer note on building and updating this vignette</em></h2>
<ul>
<li><em>Note this vignette needs to be updated - some function names
have changed since it was drafted.</em></li>
<li><em>See important info at <a href="https://r-pkgs.org/vignettes.html#sec-vignettes-how-built" class="uri">https://r-pkgs.org/vignettes.html#sec-vignettes-how-built</a></em></li>
<li><em>Vignette at EJAM-vignette.html uses devtools::document() to
build it.</em></li>
<li><em>See <a href="https://docs.ropensci.org/postdoc/" class="uri">https://docs.ropensci.org/postdoc/</a> for a quick easy way
to create html help on a pkg.
postdoc::render_package_manual(‘PKGNAME’)</em></li>
</ul>
</div>
<div id="accessing-and-using-the-code-data-app" class="section level2">
<h2>Accessing and using the code/ data/ app</h2>
<p>The app is not on a server. The R package is still in active
development, but a current version can be installed from the github
USEPA github repository. It can be installed locally as an R package,
and the data or functions can be used even without launching the shiny
app interface. This is work in progress - only the lat/lon upload may be
working right now, for example, not the NAICS/FRS queries.</p>
</div>
<div id="installing-ejam" class="section level2">
<h2>Installing EJAM</h2>
<p>You can install the development version of EJAM by cloning it from
the repository:</p>
<p><a href="https://github.com/USEPA/EJAM" class="uri">https://github.com/USEPA/EJAM</a></p>
</div>
<div id="see-the-readme-if-you-need-a-basic-intro-and-broad-overview" class="section level2">
<h2>See the <a href="https://github.com/USEPA/EJAM#readme" title="github.com/USEPA/EJAM#readme">README</a> if you need a basic
intro and broad overview</h2>
<p>You can find it here: <a href="https://github.com/USEPA/EJAM#readme" class="uri">https://github.com/USEPA/EJAM#readme</a></p>
</div>
<div id="run-the-shiny-app-on-your-own-computer-in-rstudio" class="section level2">
<h2>Run the Shiny app on your own computer, in RStudio</h2>
<p>Launch the web app with run_app() instead of shiny’s runApp() because
this shiny app is also an R package based on the golem package
framework.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(EJAM)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">run_app</span>()</span></code></pre></div>
</div>
<div id="see-documentation-of-functions-and-data" class="section level2">
<h2>See Documentation of Functions and Data</h2>
<p>See this vignette and help documentation for the package overall, and
individual functions and datasets.</p>
</div>
<div id="get-proximity-analysis-via-r-script-or-console-not-shiny-app" class="section level2">
<h2><strong>Get proximity analysis via R script or console (not shiny
app)</strong></h2>
<div id="install-other-r-packages" class="section level3">
<h3>Install other R packages</h3>
<p>Essential packages only available on the <a href="https://github.com/USEPA/EJAM" title="github.com/USEPA/EJAM">USEPA
github</a> (not CRAN) are:</p>
<ul>
<li><a href="https://github.com/USEPA/EJAM#readme" title="github.com/USEPA/EJAM">EJAM</a></li>
<li><a href="https://github.com/USEPA/EJAMejscreenapi#readme" title="github.com/USEPA/EJAMejscreenapi">EJAMejscreenapi</a></li>
<li><a href="https://github.com/USEPA/EJAMbatch.summarizer#readme" title="github.com/USEPA/EJAMbatch.summarizer">EJAMbatch.summarizer</a></li>
</ul>
</div>
<div id="reloading-the-datasets-with-info-about-blocks" class="section level3">
<h3>Reloading the datasets with info about blocks</h3>
<p>These datasets should be loaded by the app automatically or may be
when the package is loaded, depending on how the .onLoad() function is
set up.</p>
<p>To manually reload them, see the source code for the .onLoad()
function.</p>
</div>
<div id="recreating-the-index-of-where-blocks-are" class="section level3">
<h3>Recreating the index of where blocks are</h3>
<p>This index may be built when the package is loaded, automatically,
depending on how the .onLoad() function is set up in the file
EJAM/R/aaa_onLoad_create_quad_tree_index.R</p>
<p>THIS IS SLOW - It takes a few seconds. This (seemingly) must be done
for each session. One cannot save it as .rda and just load via a pkg
since it is like a pointer to the index in memory.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># One could manually rebuild the index (if quaddata were updated, for example),</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">#  by looking in the source code of the .onLoad() function, or essentially like this:</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>localtree <span class="ot">&lt;-</span> SearchTrees<span class="sc">::</span><span class="fu">createTree</span>(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>   quaddata, <span class="at">treeType =</span> <span class="st">&quot;quad&quot;</span>, <span class="at">dataType =</span> <span class="st">&quot;point&quot;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="specify-points-where-you-want-to-center-the-circular-buffers" class="section level3">
<h3>Specify points (where you want to center the circular buffers)</h3>
<div id="naics-codes-to-specify-facilities-in-one-industrial-sector" class="section level4">
<h4>NAICS Codes to Specify Facilities in one Industrial Sector</h4>
<p>Quick map of EPA-regulated facilities in one industrial category,
which you can click on to see popup windows about sites.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mapfast</span>(mysites <span class="ot">&lt;-</span> <span class="fu">frs_from_naics</span>(<span class="st">&quot;smelt&quot;</span>)) <span class="co"># may be slow the 1st time, if it lazyloads frs dataset</span></span></code></pre></div>
<p>(but note that this FRS dataset lacks NAICS for most facilities!)</p>
<p>Table of facilities in an industry, plus links to each facility in
ECHO and EJScreen</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>industryword <span class="ot">&lt;-</span> <span class="st">&quot;chemical manuf&quot;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">#  industryword &lt;- &quot;smelt&quot;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>mysites <span class="ot">&lt;-</span> <span class="fu">frs_from_naics</span>(industryword, <span class="at">children=</span><span class="cn">FALSE</span>)[,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>regids <span class="ot">&lt;-</span> mysites<span class="sc">$</span>REGISTRY_ID</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>link1 <span class="ot">&lt;-</span> <span class="fu">url_echo_facility_webpage</span>(regids, <span class="at">as_html =</span> T)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>link2 <span class="ot">&lt;-</span> <span class="fu">url_ejscreen_report</span>(<span class="at">lat =</span> mysites<span class="sc">$</span>lat, <span class="at">lon =</span> mysites<span class="sc">$</span>lon, <span class="at">distance =</span> <span class="dv">3</span>, <span class="at">as_html =</span> T)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>link3 <span class="ot">&lt;-</span> <span class="fu">url_ejscreenmap</span>(<span class="at">lat =</span> mysites<span class="sc">$</span>lat, <span class="at">lon =</span> mysites<span class="sc">$</span>lon,  <span class="at">as_html =</span> T)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>link4 <span class="ot">&lt;-</span> <span class="fu">url_ejscreen_acs_report</span>(<span class="at">lat =</span> mysites<span class="sc">$</span>lat, <span class="at">lon =</span> mysites<span class="sc">$</span>lon, <span class="at">distance =</span> <span class="dv">3</span>, <span class="at">as_html =</span> T)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co"># # same:</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co"># my_industry &lt;- naics_from_any(&quot;chemical manuf&quot;,children = F)[,.(code,name)]</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co"># mysites &lt;- frs_from_naics(my_industry$code)[,1:5]</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>mysites <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="st">`</span><span class="at">ECHO report</span><span class="st">`</span> <span class="ot">=</span> link1, </span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>                 <span class="st">`</span><span class="at">EJScreen Report</span><span class="st">`</span> <span class="ot">=</span> link2, <span class="st">`</span><span class="at">EJScreen Map</span><span class="st">`</span> <span class="ot">=</span> link3, <span class="st">`</span><span class="at">ACS Report</span><span class="st">`</span> <span class="ot">=</span> link4,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>                 mysites)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a> caption <span class="ot">=</span> <span class="fu">paste0</span>(<span class="fu">nrow</span>(mysites), <span class="st">&#39; sites have NAICS matching &quot;&#39;</span>, industryword, <span class="st">&#39;&quot;&#39;</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(mysites) <span class="sc">&gt;</span> <span class="dv">1500</span>){ mysites <span class="ot">&lt;-</span> mysites[<span class="dv">1</span><span class="sc">:</span><span class="dv">1500</span>, ]} <span class="co"># &gt;2k rows is too much for client-side DataTables</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a> <span class="fu">cat</span>(caption,<span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  DT<span class="sc">::</span><span class="fu">datatable</span>(</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    mysites,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">escape =</span> <span class="cn">FALSE</span>,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> caption,</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">filter =</span> <span class="st">&quot;top&quot;</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Map of facilities in an industry, plus popups with links to each
facility in ECHO and EJScreen</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>EJAMejscreenapi<span class="sc">::</span><span class="fu">mapfast</span>(mysites)</span></code></pre></div>
<p>NAICS/industry categories</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">naics_categories</span>()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">naics_from_any</span>(<span class="fu">naics_categories</span>(<span class="dv">3</span>))[<span class="fu">order</span>(name),.(name,code)][<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,]</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">naics_from_any</span>(<span class="fu">naics_categories</span>(<span class="dv">3</span>))[<span class="fu">order</span>(code),.(code,name)][<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,]</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># See a data table of facilities in one industry</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>industryword <span class="ot">&lt;-</span> <span class="st">&quot;pulp&quot;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="fu">frs_from_naics</span>(<span class="fu">naics_from_any</span>(industryword)<span class="sc">$</span>code)[,<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]</span></code></pre></div>
<p>Search using industry codes or text in industry names</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">naics_from_any</span>(<span class="st">&quot;plastics and rubber&quot;</span>) </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">naics_from_any</span>(<span class="dv">326</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">naics_from_any</span>(<span class="dv">326</span>, <span class="at">children =</span> T)[,.(code,name)]</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">naics_from_any</span>(<span class="st">&quot;pig&quot;</span>) </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">naics_from_any</span>(<span class="st">&quot;pig &quot;</span>) <span class="co"># space after g</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># a OR b,  a AND b,  etc.</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>a <span class="ot">=</span> <span class="fu">naics_from_any</span>(<span class="st">&quot;plastics&quot;</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>b <span class="ot">=</span> <span class="fu">naics_from_any</span>(<span class="st">&quot;rubber&quot;</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>data.table<span class="sc">::</span><span class="fu">fintersect</span>(a,b)[,.(name,code)] <span class="co">#  a AND b</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>data.table<span class="sc">::</span><span class="fu">funion</span>(a,b)[,.(name,code)]     <span class="co">#  a OR  b</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="fu">naics_subcodes_from_code</span>(<span class="fu">funion</span>(a,b)[,code])[,.(name,code)]   <span class="co">#  plus children</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="fu">naics_from_any</span>(<span class="fu">funion</span>(a,b)[,code], <span class="at">children=</span>T)[,.(name,code)] <span class="co">#  same</span></span></code></pre></div>
<p>A NAICS code can have many “children” or subcategories under it</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">NROW</span>(<span class="fu">naics_from_any</span>(<span class="st">&quot;chem&quot;</span>))</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># about 20</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">NROW</span>(<span class="fu">naics_from_any</span>(<span class="st">&quot;chem&quot;</span>, <span class="at">children =</span> T))</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># &gt;100</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">NROW</span>(<span class="fu">frs_from_naics</span>(<span class="fu">naics_from_any</span>(<span class="st">&quot;chem&quot;</span>)<span class="sc">$</span>code))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># a few thousand</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a> <span class="fu">NROW</span>(<span class="fu">frs_from_naics</span>(<span class="fu">naics_from_any</span>(<span class="st">&quot;chem&quot;</span>, <span class="at">children =</span> T)<span class="sc">$</span>code))</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"># &gt;10,000</span></span></code></pre></div>
</div>
<div id="use-latlon-point-data" class="section level4">
<h4>Use lat/lon point data</h4>
<p>Enter lat and lon to specify points</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>sitepoints2  <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">lon =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">92.1</span>, <span class="sc">-</span><span class="fl">91.8</span>), </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">lat =</span> <span class="fu">c</span>(<span class="fl">34.8799123</span>, <span class="fl">30.2906971</span>), </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">siteid =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Use lat/lon coordinates in a table like a spreadsheet - xlsx or csv
file</p>
<p>The first row should be column names including lat and lon, or
something that can be interpreted as that - see latlon_infer()</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>testjunk <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">tempdir</span>(), <span class="st">&#39;testjunk.csv&#39;</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(<span class="fu">data.frame</span>(<span class="at">LONG =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">92.1</span>, <span class="sc">-</span><span class="fl">91.8</span>), <span class="at">Latitude =</span> <span class="fu">c</span>(<span class="fl">34.8</span>, <span class="fl">30.2</span>), <span class="at">siteid =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>), <span class="at">file =</span> testjunk, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>sitepoints2 <span class="ot">&lt;-</span> <span class="fu">latlon_from_anything</span>(testjunk)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>sitepoints2</span></code></pre></div>
<p>Use test points in examples that comes with the package</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>EJAM<span class="sc">::</span>testpoints_100_dt <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">2</span>) <span class="co"># data.table, in this package</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;          lon      lat siteid</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1: -156.5141 20.88059      1</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2: -122.2602 37.97029      2</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>sitepoints100 <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">copy</span>(EJAM<span class="sc">::</span>testpoints_100_dt)  <span class="co"># [1:5, ]</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sitepoints100, <span class="dv">3</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;          lon      lat siteid</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1: -156.5141 20.88059      1</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2: -122.2602 37.97029      2</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3: -122.2134 37.47238      3</span></span></code></pre></div>
<p>Create random test data points in States of LA and TX</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>p1k <span class="ot">&lt;-</span> <span class="fu">testpoints_n</span>(<span class="dv">1000</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mapfast</span>(p1k)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mapfast</span>(<span class="fu">testpoints_n</span>(<span class="dv">300</span>, <span class="at">ST_of_blockgroup =</span> <span class="fu">c</span>(<span class="st">&#39;LA&#39;</span>,<span class="st">&#39;TX&#39;</span>)) )</span></code></pre></div>
</div>
</div>
<div id="specify-radius-for-circular-buffer-and-other-key-parameters" class="section level3">
<h3>Specify radius for circular buffer, and other key parameters</h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>radius <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="co"># radius (miles).  5 km = 3.1 miles, 10 km = 6.2 miles</span></span></code></pre></div>
</div>
<div id="key-functions-in-ejam" class="section level3">
<h3>Key Functions in EJAM</h3>
<ul>
<li><p><strong>ejamit()</strong> provides results in just one function,
by using getblocksnearby() and doaggregate():</p></li>
<li><p><strong>getblocksnearby()</strong> takes a set of points (e.g.,
facilities) and finds the Census blocks near each. Sample input is in
testpoints_100_dt, and sample output is in
sites2blocks_example.</p></li>
<li><p><strong>doaggregate()</strong> takes the list of blocks near each
point, joins it to blockgroup indicators like from EJScreen, and
aggregates at each buffered point as well as for the overall set of
unique blocks (residents). Sample input is in
sites2blocks_example.</p></li>
</ul>
</div>
<div id="get-results-in-one-step" class="section level3">
<h3>Get results in one step</h3>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="do">## This function just combines getblocksnearby() and doaggregate()</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>sitepoints <span class="ot">&lt;-</span> testpoints_1000</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># elapsed &lt;- system.time({</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>began <span class="ot">=</span> <span class="fu">Sys.time</span>()</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  out2 <span class="ot">&lt;-</span> <span class="fu">ejamit</span>(</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">sitepoints =</span>  sitepoints  ,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">radius =</span> radius</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">speedreport</span>(began, <span class="fu">Sys.time</span>(),<span class="at">n =</span> <span class="fu">NROW</span>(sitepoints))</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co"># })</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># print(elapsed)</span></span></code></pre></div>
<p>Explore results in map and table</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(out2)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="fu">as.list</span>(out2<span class="sc">$</span>results_overall))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="at">overall =</span> <span class="fu">as.list</span>( out2<span class="sc">$</span>results_overall[ , ..names_d]))</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="at">overall =</span> <span class="fu">as.list</span>( out2<span class="sc">$</span>results_overall[ , ..names_d_subgroups]))</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Site by site results in map or table:</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="fu">mapfast</span>(out2<span class="sc">$</span>results_bysite, <span class="at">radius =</span> radius)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>DT<span class="sc">::</span><span class="fu">datatable</span>(out2<span class="sc">$</span>results_bysite, <span class="at">escape =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>See summary stats about the indicators</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>outsum <span class="ot">&lt;-</span>  <span class="fu">batch.summarize</span>(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(out2<span class="sc">$</span>results_bysite), </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(out2<span class="sc">$</span>results_bysite)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(outsum<span class="sc">$</span>rows[,names_d],<span class="dv">2</span>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(outsum<span class="sc">$</span>rows[,names_d_pctile],<span class="dv">2</span>)</span></code></pre></div>
</div>
<div id="get-granular-results-step-by-step-and-view-details" class="section level3">
<h3>Get granular results step by step, and view details</h3>
<div id="getblocksnearby-will-find-residentsblocks-that-are-within-specified-distance" class="section level4">
<h4>getblocksnearby() will find residents/blocks that are within
specified distance</h4>
<p>About &lt; 1 second for 100 sites, but a few seconds for 1,000 sites,
or roughly 500k / hour for this step</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>sitepoints <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">copy</span>(EJAM<span class="sc">::</span>testpoints_100_dt) </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># or </span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># sitepoints &lt;- testpoints_n(100,&quot;block&quot;) # random points</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>elapsed <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  sites2blocks <span class="ot">&lt;-</span> EJAM<span class="sc">::</span><span class="fu">getblocksnearby</span>(</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">sitepoints =</span> sitepoints,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">radius =</span> radius,</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">quadtree =</span> localtree</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>}) <span class="co"># end of timed function</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(elapsed)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>sites2blocks</span></code></pre></div>
</div>
<div id="map-of-the-blocks-found-nearby" class="section level4">
<h4>Map of the blocks found nearby</h4>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotblocksnearby</span>(<span class="fu">testpoints_n</span>(<span class="dv">1</span>), <span class="at">radius =</span> <span class="dv">3</span>)</span></code></pre></div>
</div>
<div id="view-detailed-diagnostics-or-stats-on-the-intermediate-result" class="section level4">
<h4>View detailed diagnostics or stats on the intermediate result:</h4>
<ul>
<li>what blocks are near each site</li>
<li>how far are they</li>
<li>how many blocks are typically near a given site (population density
varies a lot)</li>
<li>how many sites are near a block (residents who have more than 1 site
near them)</li>
</ul>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Also could use this example intermediate step dataset </span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="do">## of 99 sites, with 11,567 nearby blocks:</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># sites2blocks &lt;- data.table::copy(sites2blocks_example)</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>sitepoints <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">copy</span>(EJAM<span class="sc">::</span>testpoints_100_dt) </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>sites2blocks <span class="ot">&lt;-</span> EJAM<span class="sc">::</span><span class="fu">getblocksnearby</span>(sitepoints,radius,<span class="at">quadtree =</span> localtree)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(sites2blocks)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="fu">getblocks_summarize_blocks_per_site</span>(sites2blocks) <span class="co"># print() shows more info returned invisibly</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="fu">getblocks_diagnostics</span>(sites2blocks)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Use data.table package here</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Very few blocks are within a radius of 1/4 mile.</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Hundreds are often within 1 mile, but sometimes there are only a handful or even zero.</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>s2b_stats <span class="ot">&lt;-</span> sites2blocks[ , .(</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">avgDistance =</span> <span class="fu">round</span>(<span class="fu">mean</span>(distance), <span class="dv">2</span>),</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">blocksfound =</span> .N, </span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">blocks_within_1mile =</span> <span class="fu">sum</span>(distance <span class="sc">&lt;=</span> <span class="dv">1</span>),</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">blocks_within_0.75   =</span> <span class="fu">sum</span>(distance <span class="sc">&lt;=</span> <span class="fl">0.75</span>),</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">blocks_within_0.25  =</span> <span class="fu">sum</span>(distance <span class="sc">&lt;=</span> <span class="fl">0.25</span>)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>), by <span class="ot">=</span> <span class="st">&#39;siteid&#39;</span>][<span class="fu">order</span>(blocksfound), ]</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="fu">setorder</span>(s2b_stats, siteid)</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(s2b_stats)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="co"># CDF of how many blocks are nearby a site</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">sort</span>(s2b_stats<span class="sc">$</span>blocks_within_1mile), <span class="at">main=</span><span class="st">&quot;How many blocks are near each facility?&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;# of blocks (whose internal point is) within 1 mile of each facility&quot;</span>, <span class="at">xlab=</span><span class="fu">paste0</span>(<span class="fu">nrow</span>(s2b_stats), <span class="st">&quot; facilities ranked by # of blocks nearby&quot;</span>))</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="fu">quantile</span>(s2b_stats<span class="sc">$</span>blocks_within_1mile, <span class="at">probs =</span> (<span class="dv">0</span><span class="sc">:</span><span class="dv">4</span>)<span class="sc">*</span> <span class="fl">0.25</span>))</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="fu">mean</span>(s2b_stats<span class="sc">$</span>blocks_within_1mile), <span class="at">col=</span><span class="st">&quot;red&quot;</span>)</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogram of how many blocks are nearby a site</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(sites2blocks[,.N,<span class="at">by=</span><span class="st">&quot;siteid&quot;</span>][,N],<span class="dv">20</span>, <span class="at">xlab =</span> <span class="st">&quot;How many blocks are nearby?&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;Frequency (# of sites)&quot;</span>, <span class="at">main =</span> <span class="st">&quot;A given site may have zero to hundreds of blocks nearby&quot;</span>, <span class="at">sub=</span><span class="st">&quot;A typical site in this example has about 100 blocks nearby&quot;</span>)</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>s2b_stats[,PGM_SYS_ACRNMS <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>] <span class="co"># remove verbose column</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>DT<span class="sc">::</span><span class="fu">datatable</span>(s2b_stats)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a><span class="co"># more summaries showing there may be only 1 block or several hundred blocks within 1 mile</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(s2b_stats<span class="sc">$</span>blocks_within_1mile, <span class="at">probs =</span> (<span class="dv">0</span><span class="sc">:</span><span class="dv">4</span>)<span class="sc">*</span> <span class="fl">0.25</span>)</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a><span class="fu">t</span>(<span class="fu">summary</span>(s2b_stats)) </span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a><span class="co"># map the sites with popups about how many blocks were found near each</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>(<span class="st">&#39;siteid&#39;</span> <span class="sc">%in%</span> <span class="fu">names</span>(sitepoints))) {sitepoints<span class="sc">$</span>siteid <span class="ot">&lt;-</span> <span class="fu">seq.int</span>(<span class="at">length.out =</span> <span class="fu">NROW</span>(sitepoints))}</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>s2b_stats <span class="ot">&lt;-</span> <span class="fu">merge</span>(sitepoints, s2b_stats, <span class="at">by =</span> <span class="st">&quot;siteid&quot;</span>)</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>EJAMejscreenapi<span class="sc">::</span><span class="fu">mapfast</span>(s2b_stats, <span class="at">radius =</span> radius)</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a><span class="co"># A 1 mile radius is huge within a dense urban area</span></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>EJAMejscreenapi<span class="sc">::</span><span class="fu">mapfast</span>(s2b_stats[<span class="dv">87</span><span class="sc">:</span><span class="dv">88</span>,], <span class="at">radius =</span> radius)</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Within a 1 mile radius, the blocks found tend to be about 2/3 of a mile from the site at the center.</span></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(s2b_stats<span class="sc">$</span>avgDistance)</span></code></pre></div>
<p>See map of all the block points nearby (i.e, inside the circular
buffer surrounding a site)</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">merge</span>( sites2blocks, blockpoints )</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(x, <span class="st">&#39;lat&#39;</span>, <span class="st">&#39;blocklat&#39;</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(x, <span class="st">&#39;lon&#39;</span>, <span class="st">&#39;blocklon&#39;</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">merge</span>(sitepoints, x, <span class="at">by =</span> <span class="st">&quot;siteid&quot;</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>x[,PGM_SYS_ACRNMS <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>x</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>bplot<span class="ot">=</span><span class="cf">function</span>(x,n, ... ) {<span class="fu">plot</span>(x<span class="sc">$</span>blocklon[x<span class="sc">$</span>siteid<span class="sc">==</span>n], x<span class="sc">$</span>blocklat[x<span class="sc">$</span>siteid<span class="sc">==</span>n], ... ); <span class="fu">points</span>(x<span class="sc">$</span>lon[x<span class="sc">$</span>siteid<span class="sc">==</span>n], x<span class="sc">$</span>lat[x<span class="sc">$</span>siteid<span class="sc">==</span>n] , <span class="at">col=</span><span class="st">&quot;red&quot;</span>)}</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co"># for (i in 1:20) {</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="fu">bplot</span>(x, <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(sitepoints),<span class="dv">1</span>)) <span class="co"># plots a random site surrounded by nearby block points</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span></code></pre></div>
</div>
<div id="doaggregate-will-summarize-indicators-within-each-buffer-and-overall" class="section level4">
<h4>doaggregate() will summarize indicators within each buffer and
overall</h4>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># out &lt;- doaggregate(sites2blocks_example)</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>elapsed <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>( </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">doaggregate</span>(<span class="at">sites2blocks =</span> sites2blocks) </span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>}) </span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(elapsed)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(out)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(out<span class="sc">$</span>results_bysite)</span></code></pre></div>
</div>
<div id="see-indicators-aggregated-over-all-people-across-all-sites" class="section level4">
<h4>See indicators aggregated over all people across all sites</h4>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="do">## view output of batch run aggregation ####</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="at">overall =</span> <span class="fu">as.list</span>( out<span class="sc">$</span>results_overall))</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="do">## To see just some subset of indicators, like Environmental only:</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="at">overall =</span> <span class="fu">as.list</span>( out<span class="sc">$</span>results_overall[ , ..names_e]))</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="at">overall =</span> <span class="fu">as.list</span>( out<span class="sc">$</span>results_overall[ , ..names_d]))</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="at">overall =</span> <span class="fu">as.list</span>( out<span class="sc">$</span>results_overall[ , ..names_d_subgroups]))</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="at">overall =</span> <span class="fu">as.list</span>( out<span class="sc">$</span>results_overall[ , ..names_e_pctile]))</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="at">overall =</span> <span class="fu">as.list</span>( out<span class="sc">$</span>results_overall[ , ..names_d_pctile]))</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="at">overall =</span> <span class="fu">as.list</span>( out<span class="sc">$</span>results_overall[ , ..names_ej_pctile]))</span></code></pre></div>
</div>
<div id="histogram-of-indicators-distribution-over-all-people-across-all-sites" class="section level4">
<h4>Histogram of indicators distribution over all people across all
sites</h4>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(out2<span class="sc">$</span>results_bysite<span class="sc">$</span>pctile.traffic.score,<span class="dv">10</span>, <span class="at">xlab=</span><span class="st">&quot;Local traffic scores (expressed as a percentile)&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;count of sites in each bin, out of 1,000 sites&quot;</span>, <span class="at">freq =</span> <span class="cn">TRUE</span>, <span class="at">main=</span><span class="st">&quot;Actual distribution of indicators nearby, as percentiles, vs flat line = USA overall&quot;</span>);<span class="fu">abline</span>(<span class="at">h=</span><span class="fu">nrow</span>(out2<span class="sc">$</span>results_bysite)<span class="sc">/</span><span class="dv">10</span>)</span></code></pre></div>
</div>
<div id="compare-to-results-from-ejscreen-api" class="section level4">
<h4>Compare to results from EJScreen API</h4>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>sitepoints <span class="ot">&lt;-</span> testpoints_1000_dt</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>radius <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># outapi2 &lt;- EJAMejscreenapi::ejscreenapi_plus(sitepoints[1:5, ], radius = radius, on_server_so_dont_save_files = T)</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>outapi <span class="ot">&lt;-</span> (<span class="fu">ejscreenit</span>(sitepoints[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, ], <span class="at">radius =</span> radius, <span class="at">nosave =</span> T, <span class="at">nosee =</span> T, <span class="at">interactiveprompt =</span> F))<span class="sc">$</span>table</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(<span class="fu">as.list</span>(outapi[<span class="dv">1</span>, ]))</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>outejam <span class="ot">&lt;-</span> <span class="fu">ejamit</span>(<span class="at">sitepoints =</span>  sitepoints[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, ], <span class="at">radius =</span> radius)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="fu">setdiff</span>( <span class="fu">names</span>(outapi), <span class="fu">names</span>(outejam<span class="sc">$</span>results_overall))</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;----------------</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="fu">setdiff_yx</span>( <span class="fu">names</span>(outapi), <span class="fu">names</span>(outejam<span class="sc">$</span>results_overall))</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co"># links to report or map were named differently.</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="co">#  </span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="co"># EJ pctiles, etc. might not be provided in EJAM output.</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="co"># ratios counts of denominators, demog subgroups, etc. are in EJAM only.  </span></span></code></pre></div>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
