<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="This is what getblocksnearby() uses to do the work.
Given a set of points and a specified radius in miles,
this function quickly finds all the US Census blocks near each point.
This does the work actually supporting getblocksnearby()"><title>Fast way to find nearby points (distance to each Census block centroid near each site) — getblocksnearbyviaQuadTree • EJAM</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fast way to find nearby points (distance to each Census block centroid near each site) — getblocksnearbyviaQuadTree"><meta property="og:description" content="This is what getblocksnearby() uses to do the work.
Given a set of points and a specified radius in miles,
this function quickly finds all the US Census blocks near each point.
This does the work actually supporting getblocksnearby()"><meta property="og:image" content="https://usepa.github.io/EJAM/logo.svg"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">EJAM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.2.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>Overview for EJAM Users</h6>
    <a class="dropdown-item" href="../articles/0_what_is_ejam.html">What is EJAM?</a>
    <a class="dropdown-item" href="../articles/0_webapp.html">Using EJAM</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>For analysts using R</h6>
    <a class="dropdown-item" href="../articles/1_installing.html">1. Installing the EJAM R package</a>
    <a class="dropdown-item" href="../articles/2_quickstart.html">2. Quick Start Guide</a>
    <a class="dropdown-item" href="../articles/3_analyzing.html">3. Basics of Using EJAM for Analysis in RStudio</a>
    <a class="dropdown-item" href="../articles/4_advanced.html">4. Advanced Features</a>
    <a class="dropdown-item" href="../articles/5_ejscreenapi.html">5. Using the EJScreen API via EJAM</a>
    <a class="dropdown-item" href="../articles/6_future_plans.html">6. Future Plans and Ideas for EJAM</a>
  </div>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"></ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Fast way to find nearby points (distance to each Census block centroid near each site)</h1>
      
      <div class="d-none name"><code>getblocksnearbyviaQuadTree.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This is what <code><a href="getblocksnearby.html">getblocksnearby()</a></code> uses to do the work.
Given a set of points and a specified radius in miles,
this function quickly finds all the US Census blocks near each point.
This does the work actually supporting getblocksnearby()</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">getblocksnearbyviaQuadTree</span><span class="op">(</span></span>
<span>  <span class="va">sitepoints</span>,</span>
<span>  radius <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  maxradius <span class="op">=</span> <span class="fl">31.07</span>,</span>
<span>  avoidorphans <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  report_progress_every_n <span class="op">=</span> <span class="fl">500</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  retain_unadjusted_distance <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">quadtree</span>,</span>
<span>  updateProgress <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>sitepoints</dt>
<dd><p>data.table with columns lat, lon giving point locations of sites or facilities around which are circular buffers</p></dd>


<dt>radius</dt>
<dd><p>in miles, defining circular buffer around a site point</p></dd>


<dt>maxradius</dt>
<dd><p>miles distance (max distance to check if not even 1 block point is within radius)</p></dd>


<dt>avoidorphans</dt>
<dd><p>logical If TRUE, then where not even 1 BLOCK internal point is within radius of a SITE,
it keeps looking past radius, up to maxradius, to find nearest 1 BLOCK.
What EJScreen does in that case is report NA, right? So,
does EJAM really need to report stats on residents presumed to be within radius,
if no block centroid is within radius?
Best estimate might be to report indicators from nearest block centroid which is
probably almost always the one your site is sitting inside of,
but ideally would adjust total count to be a fraction of blockwt based on
what is area of circular buffer as fraction of area of block it is apparently inside of.
Setting this to TRUE can produce unexpected results, which will not match EJScreen numbers.</p>
<p>Note that if creating a proximity score, by contrast, you instead want to find nearest 1 SITE if none within radius of this BLOCK.</p></dd>


<dt>report_progress_every_n</dt>
<dd><p>Reports progress to console after every n points,
mostly for testing, but a progress bar feature might be useful unless this is super fast.</p></dd>


<dt>quiet</dt>
<dd><p>Optional. set to TRUE to avoid message about using getblock_diagnostics(),
which is relevant only if a user saved the output of this function.</p></dd>


<dt>retain_unadjusted_distance</dt>
<dd><p>set to FALSE to drop it and save memory/storage. If TRUE,
the distance_unadjusted column will save the actual distance of site to block internal point
-- the distance column always represents distance to average resident in the block, which is
estimated by adjusting the site to block distance in cases where it is small relative to the
size of the block, to put a lower limit on it, which can result in a large estimate of distance
if the block is very large. See EJScreen documentation.</p></dd>


<dt>quadtree</dt>
<dd><p>(a pointer to the large quadtree object)
created using indexblocks() which uses the SearchTree package.
Takes about 2-5 seconds to create this each time it is needed.
It can be automatically created when the package is attached via the .onAttach() function</p></dd>


<dt>updateProgress, </dt>
<dd><p>optional function to update Shiny progress bar</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>For each point, it uses the specified search radius and finds the distance to
every block within the circle defined by the radius.
Each block is defined by its Census-provided internal point, by latitude and longitude.</p>
<p>Results are the sites2blocks table that would be used by doaggregate(),
with distance in miles as one output column of data.table.
Adjusts distance to avg resident in block when it is very small relative to block size,
the same way EJScreen adjusts distances in creating proximity scores.</p>
<p>Each point can be the location of a regulated facility or other type of site, and
the blocks are a high-resolution source of information about where
residents live.</p>
<p>Finding which blocks have their internal points in a circle provides
a way to quickly estimate what fraction of a block group is
inside the circular buffer more accurately and more quickly than
areal apportionment of block groups would provide.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="ejamit.html">ejamit()</a></code> <code><a href="getblocksnearby.html">getblocksnearby()</a></code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span>  <span class="co"># indexblocks() # if localtree not available yet, quadtree = localtree</span></span></span>
<span class="r-in"><span>  <span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="getblocksnearby.html">getblocksnearby</a></span><span class="op">(</span><span class="va">testpoints_1000</span>, radius <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Analyzing 1000 points, radius of 3 miles around each.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Finding Census blocks with internal point within  3  miles of the site (point), for each of 1000  sites (points)...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Stats via getblocks_diagnostics(), but BEFORE ADJUSTING UP FOR VERY SHORT DISTANCES: </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> min distance before adjustment:  0.00147506 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> max distance before adjustment:  2.999999 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    Summary stats on distances reported from any sites to any nearby blocks</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>no non-missing arguments to max; returning -Inf</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> -Inf miles is max. distance to block internal point (distance_unadjusted)   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2.999999 miles is max. distance to average resident in block (distance reported)   </span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>no non-missing arguments to min; returning Inf</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Inf miles is shortest distance to block internal point (distance_unadjusted)   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0.00147506 miles is shortest distance to average resident in block (distance reported)   </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>no non-missing arguments to max; returning -Inf</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>no non-missing arguments to min; returning Inf</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 999 unique output sites</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 821 blocks are near the avg site or in avg buffer</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              (based on their block internal point, like a centroid)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 819,898 blocks including doublecounting in overlaps, </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              in final row count (block-to-site pairs table)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 653,682 actual unique blocks total</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 534,730 blocks (and their residents) have exactly 1 site nearby </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 88,333 blocks (and their residents) have exactly 2 sites nearby </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 20,222 blocks (and their residents) have exactly 3 sites nearby </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1.254277 is ratio of blocks including multicounting / actual count of unique blocks</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 18.2% of unique blocks could get counted more than once </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              because those residents are near two or more sites </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              (assuming they live at the block internal point</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Adjusting upwards the very short distances now...</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  Stats via getblocks_diagnostics(), AFTER ADJUSTING up FOR SHORT DISTANCES: </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> min distance AFTER adjustment:  0.009 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> max distance AFTER adjustment:  4.32 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>DRAFT/beta</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>EJAM Version 2.2.2 beta</p>
</div>

    </footer></div>

  

  

  </body></html>

