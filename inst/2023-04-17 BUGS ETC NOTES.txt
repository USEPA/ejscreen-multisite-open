Added after 4/17/23:

UPDATE/NOT BUG: Revamp/expand the short summary report to match what EJScreen will show in their new report - Starting in late June 2023, a new EJScreen Standard Report will merge their "standard report" plus key data from "ACS report" to be a 4-page "community profile:"
 Page 1 - Summary of some demographics: languages spoken, income, age, gender; and map.
 Page 2 - EJ and Supplementary EJ indexes
 Page 3 - Table of all raw numbers on E and D
 Page 4 - All other info - climate, health, critical services, etc. 
 Their early 2023 static standard report is like this:  
   EJAM\inst\ejscreen2.1_report_example.pdf
 and the "ACS report" is like this: 
   EJAM\inst\ejscreen2.1_acs2020_report_example.pdf

UPDATE/NOT BUG: Update all numbers in usastats, statestats, and blockgroupstats at end of June 2023 when updated EJScreen numbers are made available.  also maybe EJSCREEN_Full_with_AS_CNMI_GU_VI, EJSCREEN_StatePct_with_AS_CNMI_GU_VI, States_2022, USA_2022  . Maybe use the scripts in  EJAM/inst/notes_datasets/1_SCRIPT_EJAMejscreen_download.R  or 

UPDATE/NOT BUG: Update metadata in all relevant data files .rda (via metadata_check() and metadata_add() and usethis::use_data()  ) to reflect EJScreen 2.2 instead of 2.1 (released maybe July 1 2023 or so tbd?) and ACS 2017-2021 (released Dec 2022?) instead of ACS 2016-2020.  include these at least: usastats, statestats, and blockgroupstats; EJSCREEN_Full_with_AS_CNMI_GU_VI, EJSCREEN_StatePct_with_AS_CNMI_GU_VI, States_2022, USA_2022  


2023-04-17 notes to add to issues or to do lists

	BUGS

URGENT to fix to make demos work well - make the FULL REPORT show up, at least using the placeholder images and tables, but preferable with the right contents passed via parameters - it does not work now for any view/download in app. attempted to put in placeholder and logic to see if parameters had been set but some problem with path to folder might be the issue?

URGENT to fix to make demos work well - Make the app able to work on a staging server. This means RStudio Connect server must be able to install the packages it needs like EJAMblockdata::  which is on EPA's github not CRAN and not a public repo. I don't know if it is sufficient to simply provide the repo path in the Remotes: part of the DESCRIPTION file. Dave Smith at EPA is the key contact on this server. 
 
URGENT to fix to make demos work well - "review selected sites" button/ modal table view does not work - remove button asap, then fix when have time, but soon.

URGENT to fix to make demos work well - a few related problems with query by NAICS and/or large numbers of sites: It should instantly show how many hits (sites) were found for those NAICS (via the ), before trying to slowly create a map or do anything else. Also, Map is extremely slow if NAICS query gets large number of hits, despite putting cap on how many points it can show in map -  map way too slow if picking by NAICS - if NAICS finds very large number of sites, it bogs down like in the map that gets stuck.  selecting NAICS 32552 Adhesive Manuf. clicking "Submit" it takes a full 10 seconds before the map updates to show 423 sites! that is way too long. Is the delay lazy loading the frs datasets?  preload FRS etc., so that naics query is not so slow? Also,  If it is stuck in a very long slow query or map attempt, spinner gets stuck and user should be able to somehow abort that to pick some other method of site selection, or otherwise avoid this situation with map spinner stuck when e.g., large naics query. Also, possibly related: the Summary report tab's map apparently gets created when you submit naics even before you hit start analysis? - that wastes time maybe in early steps and should not happen until analysis actually done and tables get drawn. However if large number of sites takes long to map, that will slow down 1pager report and if it does not have results popups, then you might as well predraw the map for the 1pager as soon as sites are uploaded or picked. 

URGENT to fix to make demos work well - Short report Download lacks barplot that was created by base R. Maybe needs to be a ggplot2() plot? For now, just Enable the boxplot (which was via ggplot)   if that does work in downloaded short report.

URGENT to fix to make demos work well - Replace the ugly barplot in the short report with a ggplot2 professional looking one. 

BUG: Results site by site datatable tab - fix so it can sort by siteid as a number not treat it like character (which shows the first few siteids as 1, 10, 100, 1000, 1001, 1002...). Figure out how to handle the overall summary rows though, which are avg person, avg site. 

BUG: excel download of sitebysite and overall -- some cells are errors, #NUM!  as in example of 50 sites.

BUG:  ensure 4 columns of working/clickable hyperlinks (see how they worked in ejscreenapi) to site by site table downloaded Excel version -- needs all URLs, that work:  add ACS and ECHO report urls/ links if not there -- 4 should be EJScreen report, ejscreen map, ACS report, and ECHO facility report.  

BUG: Ensure 4 columns of working hyperlinks in the interactive version of the site by site table.

BUG: medium/low priority - but asap hide these outputs until they are fixed - Fix these outputs calculations: sitecount_max, sitecount_unique, sitecount_avg -- they seem to count the wrong things. They are meant to count how many sites are within the radius, for the resident (i.e., the one block near/at this site) with the highest count of unique sites near them, for the total count of uniques sites nearby any of the residents (i.e., of all the blocks near/at this site), and for the average resident (out of all unique residents near/at this site, meaning the pop wtd avg of all unique blocks near/at this site).

BUG: if select radio button for FRS reg id, but then upload file like testpoints_50.xlsx that lacks REGISTRY_ID column, app crashes and should err gracefully instead. 

BUG: 1pager barplot view - it disappears if you resize or zoom browser window, but should just get redrawn to scale like tables and map. 

BUG: 1pager: include subgroups in 1pager plot somehow that fits well, maybe as a second plot of same type. or find way to fit all D groups and subgroups in one plot? 

BUG: 1pager download as pdf needs to work, not just as html. At least disable the option until fixed. (renamed it html for now?)

BUG: graphics tab BARPLOT  - it does not look right/ work well yet, espec for demographics since there are too many categories. 

BUG: globally change "Linguistic Isolation" (or similar) to "Limited English-Speaking Households"

BUG:  Rounding: Do not round values that are sent to excel download! only round by formatting excel to display rounded version. Except percentiles always have to be shown as 0-100 with no decimal.  Percentage variables all need to be reported or at least displayed as rounded to nearest 1 out of 100 when finally displayed/reported (not during any intermediate calculations), as done in API/EJScreen.  But in general output spreadsheet should have exact not rounded, but display them as rounded not store as rounded, in case people want to do stats work with those tables.  


	1 PAGER REPORT view and download

1pager Map popups - should have popups of results like EJAMejscreenapi:: does. 

1pager report demog and envt tables - heatmap colors? Add heatmap method to highlight ratios and also percentiles in both tables like the barplot coloring by ratio bin. See how it looks.   see excel code from EJAMejscreenapi:: and the OW heatmap, but make percentiles normal, yellow, orange, or red, if <80, 80-89, 90-94, 95-100 (red).  The ratio categories of colors should be flexible but H/M/L/0 would be ratio cutoffs of ratio is >3, >2, >1, <=1.

1pager: allow state pctiles as an option on bar/box

1pager html/pdf & browser tab vs app tab: Currently, the first view of results as a 1pager is in the results tab of the app (in contrast to EJScreen that opens it as a new browser tab) and as of 3/19/12 is not interactive. Then the user can click "Download" and it offers to save an html file locally that is also a static snapshot but can be emailed or printed, but the formatting is not really designed for printing quite yet. Instead of this, what EJAM should do is this:  At a minimum, a user needs to see at least static results immediately, just like EJScreen lets users click "get printable standard report", except that EJAM should show the results automatically once the analysis is ready. .... ********************* to be continued here.....  be able to save a pdf or print to pdf in a way that is correctly nicely formatted (page breaks need to be in the right place), similar to how EJScreen shows static results with a button to convert to PDF format (as the the standard report for the "Printable standard report" option

1pager: Avoid duplicated code and potential inconsistencies between the short table as viewed initially (which is created from code in app_server.R in lines 622-1022 roughly 400 lines of code/comments! but also with text in the app_ui.R file around lines 350-470!) versus downloaded version as html (which is created from code and text in brief_summary.Rmd). 

1pager: just a note: yet another way to format tables https://www.r-bloggers.com/2023/04/tabular-and-flextable


	MAPS and URLS in tables or popups: 

Recode addlinks_clusters_and_sort_cols() and code that calls it, to break up that function so that separate functions help add each link type, including option of ECHO, FRS, other ones than the 3 from EJScreen, and separately do the column sorting, and separately do the column that notes clusters of nearby sites. 
AND
Move all the url_e... (partly done?) functions like url_ejscreen_report() source code into the EJAM package from the EJAMejscreenapi package, but that will break EJAMejscreenapi:: functions and documentation that have been assuming those funcs are in that pkg, so need to add EJAM:: to each place or just add EJAM to the Depends section of EJAMejscreenapi DESCRIPTION file.

results map: is it only in the 1pager report? site by site tab has map too, right? There has to be an interactive results map, maybe on 1pager view, that has results in the popups like ejscreenapi map results show. map popups URLs: in results map, add the 4 working URLs/links (EJScreen report, etc.) in map popups-  - should be EJScreen report, ejscreen map, ACS report, and ECHO facility report. 

URLS: results site by site table URLs: make links work (urls) in interactive table (THEY WORK VIA ejamit() !) and ensure all 4 there if not there -- should be EJScreen report, ejscreen map, ACS report, and ECHO facility report. 

URLs for ACS and ECHO report - Add those urls/ links to EJAMejscreenapi::  in several places: map popups, interactive table, and outputs, in EJScreen API and in EJAM. should be EJScreen report, ejscreen map, ACS report, and ECHO facility report.


	EXCEL TABLES DOWNLOADED: 

Reconcile and implement code to format for excel: workbook_output_styled
  EJAMejscreenapi/R/prep_for_excel.R was renamed xls_formatting_api() 
  EJAM/R/workbook_output_styled.R   renamed something like  xls_formatting() and xls_formatting2()  
  EJAMejscreenapi/R/addlinks_clusters_and_sort_cols.R  etc.
  and xls_varname2color() etc. 
  Also maybe see https://www.r-bloggers.com/2023/04/styling-tables-for-excel-with-styledtables/ 

excel download formatting numbers: downloaded xlsx should have numeric formatting in it like zero decimals for any count variable and commas in them like for population count especially; percentiles all zero decimals; raw ej indexes maybe 2 decimals; percent variables can show xx.x% or 3 sigfigs in excel; Env vars maybe rounded based on sigfigs rules specified already in code? short report should replicate EJScreen rounding rules, but the excel table should preserve many or all digits and just limit the displayed digits using formatting!

excel download formatting: see if can set wrapping on header row and make that row height a big number, and make most columns very narrow.

excel download of sitebysite and overall -- use heatmap colors like did in ejscreenapi app.

excel download of sitebysite and overall -- confirm RATIO TO US, RATIOS TO STATE columns in excel - like on 1pager. (  maybe already there since doaggregate now outputs those)

excel download of sitebysite and overall -- add basic barplot from 1pager to the excel tab in workbook that gets downloaded.


	INTERACTIVE TABLES and plots:

Make it more obvious the site by site table has a summary row overall !!! (are there useful stats there not already on 1pager? I think so - maybe we need a longer short-report (all the stats on 1 page).

graphics tab summary:  fix "median" since now median bg not median person. 

add heatmap colors for DT::datatable https://www.r-bloggers.com/2023/04/heatmap-formatting-of-a-table-with-dt/
 
In general make datatable look nice and be useful. for better formatting of datatables in shiny, see C:/Users/mcorrale/R/mysource/EJAM/inst/notes_MISC/DT_datatable_tips_options.R


      ejscreenapi app/functions

Create interface to allow users option of using ejscreenapi for results instead of using  EJAM's doaggregate(getblocksnearby()) 

Add SUPPLEMENTAL indicators code for EJAMejscreenapi::   -- The EJScreen API is being moved or changed...   As of about 4/2023, SAIC said they will likely create a new API endpoint to provide the new fields, not modify the existing one, so we will need to update any EJAMejscreenapi code that uses the current 3/2023 API URL and doesn't yet handle the new fields (low life expectancy, supplemental indicators/indexes).  